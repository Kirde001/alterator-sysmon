#!/bin/bash

export PATH=/usr/bin:/usr/sbin:/bin:/sbin
alterator_api_version=1
. alterator-sh-functions

DB_PATH="/var/lib/syscall-inspector/data.db"
CONFIG_PATH="/etc/syscall-inspector/config.conf"

ensure_config() {
    if [ ! -f "$CONFIG_PATH" ]; then
        mkdir -p "$(dirname "$CONFIG_PATH")"
        echo "[General]" > "$CONFIG_PATH"
        echo "siem_enabled = true" >> "$CONFIG_PATH"
        echo "log_format = rfc3164" >> "$CONFIG_PATH"
    fi
}

list_data() {
    if [ ! -f "$DB_PATH" ]; then return; fi
    sqlite3 -separator "|" "$DB_PATH" \
    "SELECT timestamp, severity, event_type, process, details FROM alerts ORDER BY id DESC LIMIT 100;" 2>/dev/null |
    while IFS="|" read -r ts sev type proc det; do
        write_table_item time "$ts" severity "$sev" type "$type" process "$proc" details "$det"
    done
}

list_formats() {
    write_enum_item "rfc3164" "RFC 3164 (Standard)"
    write_enum_item "cef"     "CEF (ArcSight/Enterprise)"
    write_enum_item "json"    "JSON (Wazuh/ELK)"
}

read_config() {
    ensure_config
    
    if grep -q "^siem_enabled\s*=\s*true" "$CONFIG_PATH"; then
        write_bool_param siem_enabled true
    else
        write_bool_param siem_enabled false
    fi

    local fmt
    fmt=$(grep "^log_format" "$CONFIG_PATH" | cut -d'=' -f2 | tr -d '[:space:]')
    [ -z "$fmt" ] && fmt="rfc3164"
    
    write_string_param log_format "$fmt"
}

write_config() {
    ensure_config
    local enabled=$1
    local format=$2
    
    if [ "$enabled" = "#t" ]; then
        if grep -q "siem_enabled" "$CONFIG_PATH"; then
            sed -i 's/^siem_enabled.*/siem_enabled = true/' "$CONFIG_PATH"
        else
            echo "siem_enabled = true" >> "$CONFIG_PATH"
        fi
    else
        if grep -q "siem_enabled" "$CONFIG_PATH"; then
            sed -i 's/^siem_enabled.*/siem_enabled = false/' "$CONFIG_PATH"
        else
            echo "siem_enabled = false" >> "$CONFIG_PATH"
        fi
    fi

    if [ -n "$format" ]; then
        if grep -q "log_format" "$CONFIG_PATH"; then
            sed -i "s/^log_format.*/log_format = $format/" "$CONFIG_PATH"
        else
            echo "log_format = $format" >> "$CONFIG_PATH"
        fi
    fi

    systemctl try-restart syscall-inspector.service
}

on_message() {
    case "$in_action" in
        "list")          list_data ;;
        "list_formats")  list_formats ;;
        "read_config")   read_config ;;
        "save_config")   write_config "$in_siem_enabled" "$in_log_format" ;;
        *)               list_data ;;
    esac
}

message_loop
